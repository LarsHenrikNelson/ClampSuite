
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Mini methods &#8212; ClampSuite 0.0.3 documentation</title>
  <script>
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1e1de1a1873e13ef5536" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1e1de1a1873e13ef5536" rel="stylesheet">

  
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/6.1.2/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1e1de1a1873e13ef5536">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/design-tabs.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'analysis_methods/mini_methods';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Script usage" href="../script_usage/index.html" />
    <link rel="prev" title="Filtering tutorial" href="filtering.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">

  
  <input type="checkbox" class="sidebar-toggle" name="__primary" id="__primary">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input type="checkbox" class="sidebar-toggle" name="__secondary" id="__secondary">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fa-solid fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../index.html">

  
  
  
  
  
  
  

  
  
    <p class="title logo__title">ClampSuite 0.0.3 documentation</p>
  
</a>
    
  </div>

  
  <div class="col-lg-9 navbar-header-items">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                <li class="nav-item">
                    <a class="nav-link" href="../getting_started/index.html">
                        Getting Started
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="../modules/index.html">
                        Modules
                    </a>
                </li>
                

                <li class="nav-item current active">
                    <a class="nav-link" href="index.html">
                        Analysis methods
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="../script_usage/index.html">
                        Script usage
                    </a>
                </li>
                
    </ul>
</nav>
      </div>
      
    </div>

    <div id="navbar-end">
      <div class="navbar-end-item navbar-end__search-button-container">
        
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
      </div>
      
      <div class="navbar-end-item">
        <span class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" data-toggle="tooltip">
    <a class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></a>
    <a class="theme-switch" data-mode="dark"><i class="fa-regular fa-moon"></i></a>
    <a class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></a>
</span>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>


  
  <div class="search-button-container--mobile">
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
  </div>

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                <li class="nav-item">
                    <a class="nav-link" href="../getting_started/index.html">
                        Getting Started
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="../modules/index.html">
                        Modules
                    </a>
                </li>
                

                <li class="nav-item current active">
                    <a class="nav-link" href="index.html">
                        Analysis methods
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="../script_usage/index.html">
                        Script usage
                    </a>
                </li>
                
    </ul>
</nav>
      </div>
      
      </div>
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        <span class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" data-toggle="tooltip">
    <a class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></a>
    <a class="theme-switch" data-mode="dark"><i class="fa-regular fa-moon"></i></a>
    <a class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></a>
</span>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
    
  </div>

  
  <div class="sidebar-start-items sidebar-primary__section">
    <div class="sidebar-start-items__item"><nav class="bd-links" id="bd-docs-nav" aria-label="Section navigation">
  <p class="bd-links__title" role="heading" aria-level="1">
    Section Navigation
  </p>
  <div class="bd-toc-item navbar-nav">
    <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="filtering.html">Filtering tutorial</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Mini methods</a></li>
</ul>

  </div>
</nav>
    </div>
  </div>
  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

      </div>
      <main class="bd-main">
        
        
        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                
            </div>
            
            
            <article class="bd-article" role="main">
              
  <section id="mini-methods">
<span id="id1"></span><h1>Mini methods<a class="headerlink" href="#mini-methods" title="Permalink to this heading">#</a></h1>
<p>This section describes how mini or spontaneous postsynaptic events are found in the Mini
analysis module of ClampSuite to make the program less of a black box. For an explanation
on how to use the GUI see: <a class="reference internal" href="../modules/mini_analysis.html"><span class="doc">mini analysis</span></a>.</p>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this heading">#</a></h2>
<p>Automatic identification mini or spontaneous postsynaptic events is a somewhat challenging
analysis. Many programs use template matching. This essentially slides a template mini along
a signal and finds areas where of that highly overlap the template. Template matching works
well except if events have a large variance in amplitude and decay tau. There is a better
method. The method was first published in the paper Pernia-Andrade et al., 2012 from Peter
Jonasâ€™ lab. The Pernia-Andrade method uses FFT deconvolution to find mini events.</p>
</section>
<section id="finding-postsynaptic-events-with-fft-deconvolution">
<h2>Finding postsynaptic events with FFT deconvolution<a class="headerlink" href="#finding-postsynaptic-events-with-fft-deconvolution" title="Permalink to this heading">#</a></h2>
<p>The FFT deconvolution method is pretty good method to find postsynaptic events. Deconvolution
is used to recover an original signal that has passed through some filter. Ideally you know
what the filter is and in the case of a postsynaptic event we know an equation to describe a
postsynaptic event. To implement the FFT deconvolution to find postsynaptic events you need to
start with a signal such as the one below.</p>
<a class="reference internal image-reference" href="../_images/raw_array.png"><img alt="../_images/raw_array.png" class="align-center" src="../_images/raw_array.png" style="width: 320.0px; height: 240.0px;" /></a>
<p>The signal still needs to be filtered. Filtering has a large effect on deconvolution so be sure
to filter your signal. See the <a class="reference internal" href="filtering.html"><span class="doc">filtering tutorial</span></a> for more
for more information on filtering a signal. Esssentially the more noise your signal has
the worse the FFT deconvolution works. Here a well filtered version of the signal above:</p>
<a class="reference internal image-reference" href="../_images/filtered_array.png"><img alt="../_images/filtered_array.png" class="align-center" src="../_images/filtered_array.png" style="width: 320.0px; height: 240.0px;" /></a>
<p>Next step is to create a template mini using the code below and insert it into a kernel.
While the exact shape of the template is not very important the spacer that offsets the template
from the start of the kernel is very important as this changes were the postsynaptic event will
be found. ClampSuite uses a kernel that identifies postsynatpic events right before they start.
The kernel is an array, the same length as your signal of interested filled with zeros
everywhere except where the template will be placed. See below for an example template and kernel.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">tau_2</span> <span class="o">/</span> <span class="n">tau_1</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">tau_1</span> <span class="o">/</span> <span class="p">(</span><span class="n">tau_1</span> <span class="o">-</span> <span class="n">tau_2</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">amplitude</span> <span class="o">/</span> <span class="n">A</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">t_length</span> <span class="o">/</span> <span class="n">tau_1</span><span class="p">)))</span> <span class="o">**</span> <span class="n">risepower</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="o">-</span><span class="n">t_length</span> <span class="o">/</span> <span class="n">tau_2</span><span class="p">))))</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/template_kernel.png"><img alt="../_images/template_kernel.png" class="align-center" src="../_images/template_kernel.png" style="width: 600.0px; height: 200.0px;" /></a>
<p>Once your kernel is created you take the fast Fourier transform (FFT) of the signal and the kernel.
Then you divide the signal FFT by the kernel FFT take the inverse FFT of the resulting division.
The filtered deconvolved array will have peaks where the postsynaptic events are. The deconvolved
array needs to be filtered otherwise the peaks can be hidden in the noise.</p>
<a class="reference internal image-reference" href="../_images/decon.png"><img alt="../_images/decon.png" class="align-center" src="../_images/decon.png" style="width: 600.0px; height: 200.0px;" /></a>
<p>The you can use use a peak finding function like the find_peaks provided on by Scipy to
find all the events. The events still need to be checked and analyzed. Sometimes the
deconvolved peaks overlap leading to duplicated events, however this can be easily be
checked during analysis.</p>
<a class="reference internal image-reference" href="../_images/events.png"><img alt="../_images/events.png" class="align-center" src="../_images/events.png" style="width: 600.0px; height: 200.0px;" /></a>
<p>Here is the code to run the deconvolution and peak finding:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">fft</span><span class="p">,</span> <span class="n">signal</span>

<span class="kn">from</span> <span class="nn">clampsuite.functions.template_psc</span> <span class="kn">import</span> <span class="n">create_template</span>
<span class="kn">from</span> <span class="nn">clampsuite.functions.filtering_functions</span> <span class="kn">import</span> <span class="n">fir_zero_1</span>

<span class="n">acq_fft</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">((</span><span class="n">acq</span><span class="o">.</span><span class="n">plot_acq_y</span><span class="p">()))</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">create_template</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=-</span><span class="mi">20</span><span class="p">)</span>

<span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">acq</span><span class="o">.</span><span class="n">plot_acq_y</span><span class="p">()))</span>
<span class="n">kernel</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">template</span><span class="p">)]</span> <span class="o">=</span> <span class="n">template</span>
<span class="n">kernel_fft</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>

<span class="n">decon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">acq_fft</span> <span class="o">/</span> <span class="n">kernel_fft</span><span class="p">))</span>
<span class="n">decon_filtered</span> <span class="o">=</span> <span class="n">fir_zero_1</span><span class="p">(</span>
    <span class="n">array</span><span class="o">=</span><span class="n">decon</span><span class="p">,</span>
    <span class="n">sample_rate</span><span class="o">=</span><span class="n">acq</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">,</span>
    <span class="n">order</span><span class="o">=</span><span class="mi">351</span><span class="p">,</span>
    <span class="n">high_pass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">high_width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">low_pass</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">low_width</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">window</span><span class="o">=</span><span class="s2">&quot;hann&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1">#%%</span>
<span class="n">bottom</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">decon_filtered</span><span class="p">,</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">])</span>
<span class="n">middle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
    <span class="n">decon_filtered</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">((</span><span class="n">decon_filtered</span> <span class="o">&gt;</span> <span class="n">bottom</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">decon_filtered</span> <span class="o">&lt;</span> <span class="n">top</span><span class="p">))]</span>
<span class="p">)</span>
<span class="c1"># Calculate the mean and rms.</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">middle</span><span class="p">)</span>
<span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">middle</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)))</span>

<span class="c1"># Find the events.</span>
<span class="n">peaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span>
    <span class="n">decon_filtered</span> <span class="o">-</span> <span class="n">mu</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mf">4.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">rms</span><span class="p">),</span>
    <span class="n">distance</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10000</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">),</span>
    <span class="n">prominence</span><span class="o">=</span><span class="n">rms</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>


            </article>
            
            
            
            <footer class="bd-footer-article">
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
  <a class='left-prev' id="prev-link" href="filtering.html" title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
          <p class="prev-next-subtitle">previous</p>
          <p class="prev-next-title">Filtering tutorial</p>
      </div>
  </a>
  <a class='right-next' id="next-link" href="../script_usage/index.html" title="next page">
  <div class="prev-next-info">
      <p class="prev-next-subtitle">next</p>
      <p class="prev-next-title">Script usage</p>
  </div>
  <i class="fa-solid fa-angle-right"></i>
  </a>
</div>
            </footer>
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
<div class="tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
</div>
<nav id="bd-toc-nav" class="page-toc">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#background">
   Background
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#finding-postsynaptic-events-with-fft-deconvolution">
   Finding postsynaptic events with FFT deconvolution
  </a>
 </li>
</ul>

</nav>
</div>

<div class="toc-item">
  
<div id="searchbox"></div>
</div>

<div class="toc-item">
  
</div>

<div class="toc-item">
  
<div class="tocsection sourcelink">
    <a href="../_sources/analysis_methods/mini_methods.rst.txt">
        <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
</div>

</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
          </div>
        </footer>
        
      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1e1de1a1873e13ef5536"></script>

  <footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    
<p class="copyright">

    &copy; Copyright 2022, Lars Henrik Nelson.<br>

</p>

  </div>
  
  <div class="footer-item">
    
<p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.<br>
</p>

  </div>
  
</div>
  </footer>
  </body>
</html>